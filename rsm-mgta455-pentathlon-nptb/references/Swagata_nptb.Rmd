---
title: "Pentathlon III: Next Product to Buy Modeling"
output: html_document
---

* Team-lead gitlab id:
* Team-lead gitlab username:
* Group number:
* Group name:
* Team member names:

```{r r_setup, include = FALSE}
## initial settings
knitr::opts_chunk$set(
  comment = NA,
  echo = TRUE,
  error = TRUE,
  cache = FALSE,
  message = FALSE,
  dpi = 96,
  warning = FALSE
)

## width to use when printing tables etc.
options(
  width = 250,
  scipen = 100,
  max.print = 5000,
  stringsAsFactors = FALSE
)

## load radiant packages if neededi
if (!exists("r_environment")) library(radiant)
```

<style>
.table {
  width: auto;
}
ul, ol {
  padding-left: 18px;
}
pre, code, pre code {
  overflow: auto;
  white-space: pre;
  word-wrap: normal;
  background-color: #ffffff;
}
</style>

## Setup

Please complete this Rmarkdown document by answering the questions in `pentathlon-nptb.pdf` on Dropbox (week8/readings/). The code block below will load the data you need. Please DO NOT change the code used to load the data. Create an HTML file with all your results and comments and push both the Rmarkdown and HTML file to GitLab when you are done. As always, all results MUST be reproducible (i.e., the TA and I must be able to recreate the HTML from the R-markdown file without changes or errors).

Good luck!

```{r}
## Loading the data from Dropbox/MGTA455-2018/data/
pentathlon_nptb_wrk <- readr::read_rds(file.path(radiant.data::find_dropbox(), "MGTA455-2018/data/pentathlon_nptb.rds"))
if (!exists("r_data")) r_data <- list()
r_data[["pentathlon_nptb_wrk"]] <- readr::read_rds(file.path(find_dropbox(), "MGTA455-2018/data/pentathlon_nptb.rds"))
```

## Question answers

Loading libraries
```{r}
library(radiant)
library(ranger)
install.packages("randomForest")
library(randomForest)
library(readr)
library(dplyr)
library(rpart)
library(rpart.plot)
library(xgboost)
library(Matrix)
library(radiant)
library(methods)
library(caret)
library(data.table)
install.packages("mlr")
library(mlr)
```

## Dividing training, validation, representative datasets:
```{r}
r_data[["pentathlon_nptb_train"]]  <- r_data[["pentathlon_nptb_wrk"]] %>% filter(training==1)
r_data[["pentathlon_nptb_validation"]] <- r_data[["pentathlon_nptb_wrk"]] %>% filter(training==0)
r_data[["pentathlon_nptb_rep"]] <- r_data[["pentathlon_nptb_wrk"]] %>% filter(is.na(training))

## note training and valid both have 50% buyers and 50% non buyers, but rep sample has 1% buyers and 99% non buyers.
```


## Logistic Regression  Base Model:

```{r fig.width = 18.85, fig.height = 65.96, dpi = 96}
visualize(
  dataset = "pentathlon_nptb", 
  xvar = c(
    "message", "age", "gender", "income", "education","freq_endurance", 
    "freq_team", "endurance_os", "strength_os", "water_os", 
    "team_os", "backcountry_os", "winter_os", "racquet_os"
  ), 
  yvar = "buyer", 
  type = "bar", 
  custom = FALSE
)
```

Logistic

a) Regression:
```{r}
result_logistic <- logistic(
  dataset = "pentathlon_nptb_train", 
  rvar = "buyer", 
  evar = c(
    "message", "age", "gender", "income", "education", "children", 
    "freq_endurance", "freq_strength", "freq_water", "freq_team", 
    "freq_backcountry", "freq_winter", "freq_racquet"
  ), 
  lev = "yes", 
  int = c(
    "message:age", "message:gender", 
    "message:income", "message:education", 
    "message:children", "message:freq_endurance", 
    "message:freq_strength", 
    "message:freq_water", 
    "message:freq_team", 
    "message:freq_backcountry", 
    "message:freq_winter", 
    "message:freq_racquet"
  ), 
  check = "standardize"
)
summary(result_logistic, sum_check = "confint")
```


```{r}
## training:
pred <- predict(result_logistic, pred_data = "pentathlon_nptb_train", pred_cmd = "message='endurance'")
store(pred, data = "pentathlon_nptb_train", name = "p_logit_endurance")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_train", pred_cmd = "message='strength'")
store(pred, data = "pentathlon_nptb_train", name = "p_logit_strength")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_train", pred_cmd = "message='water'")
store(pred, data = "pentathlon_nptb_train", name = "p_logit_water")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_train", pred_cmd = "message='team'")
store(pred, data = "pentathlon_nptb_train", name = "p_logit_team")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_train", pred_cmd = "message='backcountry'")
store(pred, data = "pentathlon_nptb_train", name = "p_logit_backcountry")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_train", pred_cmd = "message='winter'")
store(pred, data = "pentathlon_nptb_train", name = "p_logit_winter")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_train", pred_cmd = "message='racquet'")
store(pred, data = "pentathlon_nptb_train", name = "p_logit_racquet")


## test:
pred <- predict(result_logistic, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='endurance'")
store(pred, data = "pentathlon_nptb_validation", name = "p_logit_endurance")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='strength'")
store(pred, data = "pentathlon_nptb_validation", name = "p_logit_strength")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='water'")
store(pred, data = "pentathlon_nptb_validation", name = "p_logit_water")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='team'")
store(pred, data = "pentathlon_nptb_validation", name = "p_logit_team")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='backcountry'")
store(pred, data = "pentathlon_nptb_validation", name = "p_logit_backcountry")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='winter'")
store(pred, data = "pentathlon_nptb_validation", name = "p_logit_winter")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='racquet'")
store(pred, data = "pentathlon_nptb_validation", name = "p_logit_racquet")



## Representative:
pred <- predict(result_logistic, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='endurance'")
store(pred, data = "pentathlon_nptb_rep", name = "p_logit_endurance")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='strength'")
store(pred, data = "pentathlon_nptb_rep", name = "p_logit_strength")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='water'")
store(pred, data = "pentathlon_nptb_rep", name = "p_logit_water")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='team'")
store(pred, data = "pentathlon_nptb_rep", name = "p_logit_team")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='backcountry'")
store(pred, data = "pentathlon_nptb_rep", name = "p_logit_backcountry")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='winter'")
store(pred, data = "pentathlon_nptb_rep", name = "p_logit_winter")

pred <- predict(result_logistic, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='racquet'")
store(pred, data = "pentathlon_nptb_rep", name = "p_logit_racquet")

```

New variables creation

```{r}
## create new variable(s)
r_data[["pentathlon_nptb_train"]] <- mutate(r_data[["pentathlon_nptb_train"]], to_offer = c("endurance","strength","water","team","backcountry","winter","racquet")[which.pmax(p_logit_endurance, p_logit_strength, p_logit_water, p_logit_team,p_logit_backcountry, p_logit_winter,p_logit_racquet )])


r_data[["pentathlon_nptb_validation"]] <- mutate(r_data[["pentathlon_nptb_validation"]], to_offer = c("endurance","strength","water","team","backcountry","winter","racquet")[which.pmax(p_logit_endurance, p_logit_strength, p_logit_water, p_logit_team,p_logit_backcountry, p_logit_winter,p_logit_racquet )])


r_data[["pentathlon_nptb_rep"]] <- mutate(r_data[["pentathlon_nptb_rep"]], to_offer = c("endurance","strength","water","team","backcountry","winter","racquet")[which.pmax(p_logit_endurance, p_logit_strength, p_logit_water, p_logit_team,p_logit_backcountry, p_logit_winter,p_logit_racquet )])
# endurance_exp_profit = 0.4*predict_ord_endurance*p_logit_endurance
```




Linear regression to predict Order size:

```{r}
pentathlon_nptb_train <- as.data.frame(r_data[["pentathlon_nptb_train"]])
pentathlon_nptb_train_bought <- filter(pentathlon_nptb_train, buyer=="yes")
result_linear <- regress(
  dataset = "pentathlon_nptb_train_bought", 
  rvar = "total_os", 
  evar = c(
    "message", "age", "gender", "income", "education", "children", 
    "freq_endurance", "freq_strength", "freq_water", "freq_team", 
    "freq_backcountry", "freq_winter", "freq_racquet"
  ), 
  check = "standardize"
)
summary(result_linear, sum_check = c("rmse", "vif"))
# store(result, name = "residuals_reg")
```

Store Order size:
```{r}
## training
pred <- predict(result_linear, pred_data = "pentathlon_nptb_train", pred_cmd = "message='endurance'")
store(pred, data = "pentathlon_nptb_train", name = "predict_ord_endurance")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_train", pred_cmd = "message='strength'")
store(pred, data = "pentathlon_nptb_train", name = "predict_ord_strength")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_train", pred_cmd = "message='water'")
store(pred, data = "pentathlon_nptb_train", name = "predict_ord_water")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_train", pred_cmd = "message='team'")
store(pred, data = "pentathlon_nptb_train", name = "predict_ord_team")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_train", pred_cmd = "message='backcountry'")
store(pred, data = "pentathlon_nptb_train", name = "predict_ord_backcountry")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_train", pred_cmd = "message='winter'")
store(pred, data = "pentathlon_nptb_train", name = "predict_ord_winter")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_train", pred_cmd = "message='racquet'")
store(pred, data = "pentathlon_nptb_train", name = "predict_ord_racquet")


## Validation:
pred <- predict(result_linear, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='endurance'")
store(pred, data = "pentathlon_nptb_validation", name = "predict_ord_endurance")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='strength'")
store(pred, data = "pentathlon_nptb_validation", name = "predict_ord_strength")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='water'")
store(pred, data = "pentathlon_nptb_validation", name = "predict_ord_water")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='team'")
store(pred, data = "pentathlon_nptb_validation", name = "predict_ord_team")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='backcountry'")
store(pred, data = "pentathlon_nptb_validation", name = "predict_ord_backcountry")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='winter'")
store(pred, data = "pentathlon_nptb_validation", name = "predict_ord_winter")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_validation", pred_cmd = "message='racquet'")
store(pred, data = "pentathlon_nptb_validation", name = "predict_ord_racquet")

#pentathlon_nptb_train <- as.data.frame(r_data[["pentathlon_nptb_train"]])
#pentathlon_nptb_validation <- as.data.frame(r_data[["pentathlon_nptb_validation"]])


## Representative:
pred <- predict(result_linear, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='endurance'")
store(pred, data = "pentathlon_nptb_rep", name = "predict_ord_endurance")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='strength'")
store(pred, data = "pentathlon_nptb_rep", name = "predict_ord_strength")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='water'")
store(pred, data = "pentathlon_nptb_rep", name = "predict_ord_water")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='team'")
store(pred, data = "pentathlon_nptb_rep", name = "predict_ord_team")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='backcountry'")
store(pred, data = "pentathlon_nptb_rep", name = "predict_ord_backcountry")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='winter'")
store(pred, data = "pentathlon_nptb_rep", name = "predict_ord_winter")

pred <- predict(result_linear, pred_data = "pentathlon_nptb_rep", pred_cmd = "message='racquet'")
store(pred, data = "pentathlon_nptb_rep", name = "predict_ord_racquet")

pentathlon_nptb_train <- as.data.frame(r_data[["pentathlon_nptb_train"]])
pentathlon_nptb_validation <- as.data.frame(r_data[["pentathlon_nptb_validation"]])
pentathlon_nptb_rep <- as.data.frame(r_data[["pentathlon_nptb_rep"]])

```



Impute Order size negative values with 0:
```{r}

pentathlon_nptb_train <- pentathlon_nptb_train %>% 
  mutate(predict_ord_endurance = ifelse(predict_ord_endurance<0, 0 , predict_ord_endurance),
         predict_ord_strength = ifelse(predict_ord_strength<0, 0 , predict_ord_strength),
         predict_ord_water = ifelse(predict_ord_water<0, 0 , predict_ord_water),
         predict_ord_team = ifelse(predict_ord_team<0, 0 , predict_ord_team),
         predict_ord_backcountry = ifelse(predict_ord_backcountry<0, 0 , predict_ord_backcountry),
         predict_ord_winter = ifelse(predict_ord_winter<0, 0 , predict_ord_winter),
         predict_ord_racquet = ifelse(predict_ord_racquet<0, 0 , predict_ord_racquet)
         )

pentathlon_nptb_validation <- pentathlon_nptb_validation %>% 
  mutate(predict_ord_endurance = ifelse(predict_ord_endurance<0, 0 , predict_ord_endurance),
         predict_ord_strength = ifelse(predict_ord_strength<0, 0 , predict_ord_strength),
         predict_ord_water = ifelse(predict_ord_water<0, 0 , predict_ord_water),
         predict_ord_team = ifelse(predict_ord_team<0, 0 , predict_ord_team),
         predict_ord_backcountry = ifelse(predict_ord_backcountry<0, 0 , predict_ord_backcountry),
         predict_ord_winter = ifelse(predict_ord_winter<0, 0 , predict_ord_winter),
         predict_ord_racquet = ifelse(predict_ord_racquet<0, 0 , predict_ord_racquet)
         )


pentathlon_nptb_rep <- pentathlon_nptb_rep %>% 
  mutate(predict_ord_endurance = ifelse(predict_ord_endurance<0, 0 , predict_ord_endurance),
         predict_ord_strength = ifelse(predict_ord_strength<0, 0 , predict_ord_strength),
         predict_ord_water = ifelse(predict_ord_water<0, 0 , predict_ord_water),
         predict_ord_team = ifelse(predict_ord_team<0, 0 , predict_ord_team),
         predict_ord_backcountry = ifelse(predict_ord_backcountry<0, 0 , predict_ord_backcountry),
         predict_ord_winter = ifelse(predict_ord_winter<0, 0 , predict_ord_winter),
         predict_ord_racquet = ifelse(predict_ord_racquet<0, 0 , predict_ord_racquet)
         )

```

Profits :
```{r}
pentathlon_nptb_validation <- pentathlon_nptb_validation %>% 
  mutate(profit_endurance = 0.4*predict_ord_endurance*p_logit_endurance,
         profit_strength = 0.4*predict_ord_strength*p_logit_strength,
         profit_water = 0.4*predict_ord_water*p_logit_water,
         profit_team = 0.4*predict_ord_team*p_logit_team,
         profit_backcountry = 0.4*predict_ord_backcountry*p_logit_backcountry,
         profit_winter = 0.4*predict_ord_winter*p_logit_winter,
         profit_racquet = 0.4*predict_ord_racquet*p_logit_racquet
         )


pentathlon_nptb_validation <- pentathlon_nptb_validation %>% 
  mutate(to_offer_dept = c("endurance","strength","water","team","backcountry","winter","racquet")[which.pmax(profit_endurance, profit_strength, profit_water, profit_team,profit_backcountry, profit_winter,profit_racquet )]) %>% 
  mutate(profit_max = pmax(profit_endurance, profit_strength, profit_water, profit_team,profit_backcountry, profit_winter,profit_racquet ))




t1 <- sum(pentathlon_nptb_validation$profit_max)
t2 <- sum(pentathlon_nptb_validation$total_os)

t1/t2


pentathlon_nptb_rep <- pentathlon_nptb_rep %>% 
  mutate(pAdj_logit_endurance = p_logit_endurance/ (p_logit_endurance + (1-p_logit_endurance)*(1-0.01)/0.01),
         pAdj_logit_strength = p_logit_strength/ (p_logit_strength + (1-p_logit_strength)*(1-0.01)/0.01),
         pAdj_logit_water = p_logit_water/ (p_logit_water + (1-p_logit_water)*(1-0.01)/0.01),
         pAdj_logit_team = p_logit_team/ (p_logit_team + (1-p_logit_team)*(1-0.01)/0.01),
         pAdj_logit_backcountry = p_logit_backcountry/ (p_logit_backcountry + (1-p_logit_backcountry)*(1-0.01)/0.01),
         pAdj_logit_winter = p_logit_winter/ (p_logit_winter + (1-p_logit_winter)*(1-0.01)/0.01),
         pAdj_logit_racquet = p_logit_racquet/ (p_logit_racquet + (1-p_logit_racquet)*(1-0.01)/0.01)
         )

pentathlon_nptb_rep <- pentathlon_nptb_rep %>% 
  mutate(profit_endurance = 0.4*predict_ord_endurance*pAdj_logit_endurance,
         profit_strength = 0.4*predict_ord_strength*pAdj_logit_strength,
         profit_water = 0.4*predict_ord_water*pAdj_logit_water,
         profit_team = 0.4*predict_ord_team*pAdj_logit_team,
         profit_backcountry = 0.4*predict_ord_backcountry*pAdj_logit_backcountry,
         profit_winter = 0.4*predict_ord_winter*pAdj_logit_winter,
         profit_racquet = 0.4*predict_ord_racquet*pAdj_logit_racquet
         )


pentathlon_nptb_rep <- pentathlon_nptb_rep %>% 
  mutate(to_offer_dept = c("endurance","strength","water","team","backcountry","winter","racquet")[which.pmax(profit_endurance, profit_strength, profit_water, profit_team,profit_backcountry, profit_winter,profit_racquet )]) %>% 
  mutate(profit_max = pmax(profit_endurance, profit_strength, profit_water, profit_team,profit_backcountry, profit_winter,profit_racquet ))

t1 <- sum(pentathlon_nptb_rep$profit_max)
t2 <- sum(pentathlon_nptb_rep$total_os)

t1/t2

```

## XGBoost Model:
```{r}
train  <- r_data[["pentathlon_nptb_wrk"]] %>% filter(training==1)
validation <- r_data[["pentathlon_nptb_wrk"]] %>% filter(training==0)
xgb_pentathlon_nptb_rep <- r_data[["pentathlon_nptb_wrk"]] %>% filter(is.na(training))
```

```{r}
xgb_pentathlon_nptb_train <- train[,c(
    "message", "age", "gender", "income", "education", "children", 
    "freq_endurance", "freq_strength", "freq_water", "freq_team", 
    "freq_backcountry", "freq_winter", "freq_racquet"
  )]
xgb_pentathlon_nptb_validation <-validation[,c(
    "message", "age", "gender", "income", "education", "children", 
    "freq_endurance", "freq_strength", "freq_water", "freq_team", 
    "freq_backcountry", "freq_winter", "freq_racquet"
  )]
```



  rvar = "buyer", 
  evar = c(
    "message", "age", "gender", "income", "education", "children", 
    "freq_endurance", "freq_strength", "freq_water", "freq_team", 
    "freq_backcountry", "freq_winter", "freq_racquet"
  ), 
  lev = "yes", 
  int = c(
    "message:age", "message:gender", 
    "message:income", "message:education", 
    "message:children", "message:freq_endurance", 
    "message:freq_strength", 
    "message:freq_water", 
    "message:freq_team", 
    "message:freq_backcountry", 
    "message:freq_winter", 
    "message:freq_racquet"
  ),
  
```{r}
##XGBoost
validation$buyer <- ifelse(validation$buyer == "yes", 1,0)
train$buyer <- ifelse(train$buyer == "yes", 1,0)

dtrain <- xgb.DMatrix(data=data.matrix(xgb_pentathlon_nptb_train), label=train$buyer)
dvalidation <- xgb.DMatrix(data=data.matrix(xgb_pentathlon_nptb_validation), label=validation$buyer)

watchlist <- list(validation=dvalidation, train=dtrain)

param <- list(
  objective = "binary:logistic",
  eta = 0.0025,
  gamma= 0.10,
  #max_depth = 8,
  subsample = 0.30,
  colsample_bytree = .75,
  scale_pos_weight = 0.97,
  min_child_weight = 30,
  max_delta_step = 7,
  lambda = 20
)

xgb_model <- xgb.train( params = param,
                  data = dtrain,
                  nfold=3,
                  eval_metric="logloss",
                  print_every_n = 50,
                  nrounds = 4400,
                  num_boost_round=10,
                  seed = 123,
                  verbose = 1,
                  early_stopping_rounds = 500,
                  watchlist = watchlist
)

pred <- predict(xgb_model, data.matrix(xgb_pentathlon_nptb_validation))
r_data[["pentathlon_nptb_validation"]]$xgb_prob <- pred

imp <- xgb.importance (feature_names = colnames(dtrain),model = xgb_model)
xgb.plot.importance (importance_matrix = imp)
```


```{r}
xgb_grid_1 = expand.grid(
nrounds = 1000,
eta = c(0.01, 0.001, 0.0001),
max_depth = c(2, 4, 6, 8, 10),
gamma = 1
)
 
# pack the training control parameters
xgb_trcontrol_1 = trainControl(
method = "cv",
number = 5,
verboseIter = TRUE,
returnData = FALSE,
returnResamp = "all",                                                        # save losses across all models
classProbs = TRUE,                                                           # set to TRUE for AUC to be computed
summaryFunction = twoClassSummary,
allowParallel = TRUE
)
 
# train the model for each parameter combination in the grid,
#   using CV to evaluate
xgb_train_1 = train(
x = as.matrix(df_train %>%
select(-SeriousDlqin2yrs)),
y = as.factor(df_train$SeriousDlqin2yrs),
trControl = xgb_trcontrol_1,
tuneGrid = xgb_grid_1,
method = "xgbTree"
)
 
# scatter plot of the AUC against max_depth and eta
ggplot(xgb_train_1$results, aes(x = as.factor(eta), y = max_depth, size = ROC, color = ROC)) +
geom_point() +
theme_bw() +
scale_size_continuous(guide = "none")
```



#### using Caret

```{r}


#set variable names
setcol <- c(
    "message", "age", "gender", "income", "education", "children", 
    "freq_endurance", "freq_strength", "freq_water", "freq_team", 
    "freq_backcountry", "freq_winter", "freq_racquet"
  )

train_0<-r_data[["pentathlon_nptb_wrk"]] %>% filter(training==1)
test_0<- r_data[["pentathlon_nptb_wrk"]] %>% filter(training==0)

train_labels <- as.numeric(train_0$buyer)-1
test_labels <- as.numeric(test_0$buyer)-1

train <-train_0[,setcol]
test <-train_0[,setcol]

#convert data frame to data table
setDT(train) 
setDT(test)

#using one hot encoding 


# one-hot-encoding categorical features
ohe_feats = c('message', 'age', 'gender')

dummies_train <- dummyVars(~ message +  age + gender, data = train)
dummies_test <- dummyVars(~ message +  age + gender, data = test)

df_all_oh_train <- as.data.frame(predict(dummies_train, newdata = train))
df_all_oh_test <- as.data.frame(predict(dummies_test, newdata = test))

## train preprocessing:
df_train_combined <- cbind(train[,-c(which(colnames(train) %in% ohe_feats))],df_all_oh_train)
df_train_combined$age_30 <- as.numeric(ifelse(df_train_combined[,"age.< 30"] < 0,1,0))
df_train_combined$age_31_44 <- as.numeric(ifelse(df_train_combined[,"age.30 to 44"] < 0,1,0))
df_train_combined$age_45_59 <- as.numeric(ifelse(df_train_combined[,"age.45 to 59"] < 0,1,0))
df_train_combined$age_60 <- as.numeric(ifelse(df_train_combined[,"age.>= 60"] < 0,1,0))


df_test_combined <- cbind(test[,-c(which(colnames(test) %in% ohe_feats))],df_all_oh_test)
df_test_combined$age_30 <- as.numeric(ifelse(df_test_combined[,"age.< 30"] < 0,1,0))
df_test_combined$age_31_44 <- as.numeric(ifelse(df_test_combined[,"age.30 to 44"] < 0,1,0))
df_test_combined$age_45_59 <- as.numeric(ifelse(df_test_combined[,"age.45 to 59"] < 0,1,0))
df_test_combined$age_60 <- as.numeric(ifelse(df_test_combined[,"age.>= 60"] < 0,1,0))

#preparing matrix 
dtrain <- xgb.DMatrix(data = data.matrix(df_train_combined),label = train_labels) 
dtest <- xgb.DMatrix(data = data.matrix(df_test_combined),label=test_labels)


#default parameters
params <- list(
  booster = "gbtree", 
  objective = "binary:logistic", 
  eta=0.003, 
  gamma=0, 
  max_depth=6, 
  min_child_weight=1, 
  subsample=1, 
  colsample_bytree=1)


watchlist <- list(validation=dtest, train=dtrain)


# param <- list(
#   objective = "binary:logistic",
#   eta = 0.0025,
#   gamma= 0.10,
#   #max_depth = 8,
#   subsample = 0.30,
#   colsample_bytree = .75,
#   scale_pos_weight = 0.97,
#   min_child_weight = 30,
#   max_delta_step = 7,
#   lambda = 20
# )

xgbcv <- xgb.cv( 
  params = params, 
  data = dtrain, 
  nrounds = 1000, 
  nfold = 4, 
  showsd = T, 
  stratified = T, 
  print.every.n = 10, 
  early.stop.round = 200, 
  maximize = F)
##best iteration = 79


min(xgbcv$test.error.mean)


xgb_model <- xgb.train( params = params,
                  data = dtrain,
                  nfold=3,
                  eval_metric="error",
                  print_every_n = 50,
                  nrounds = 4400,
                  num_boost_round=10,
                  seed = 123,

                  verbose = 1,
                  early_stopping_rounds = 500,
                  watchlist = watchlist
)

pred <- predict(xgb_model, (dtest))



```
